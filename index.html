<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
  </head>

  <body>
    <h1>WHERE CAN I SEE ______?</h1>

    <p id="more-info">Please wait while the data loads. This may take up to a minute.</p>

    <p>This map's information came from the
      <a href="https://www.kaggle.com/nationalparkservice/park-biodiversity/data">
        National Park Service
      </a>
    </p>

    <div id="map"></div>
  </body>
</html>


<style>

  h1, p {
    text-align: center;
  }

  p {
    font-size: 20px;
  }

  a {
    text-decoration: none;
    color: #cecece;
  }

  a:hover {
    color: black;
  }

  path {
    fill: #cecece;
    stroke: white;
  }

  /*
  Followed http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html
  tutorial while creating the tooltip
  */
  div.tooltip {
    position: absolute;
    text-align: center;
    color: #909090;
    width: 160px;
    height: 55px;
    padding: 2px;
    font: 14px;
    background: white;
    border: 0px;
    border-radius: 4px;
    pointer-events: none;
  }

  .legend {
    position: absolute;
    top: 130px;
    background-color: white;
    border-radius: 3px;
    opacity: 0.78;
  }

  circle {
    fill: black;
    opacity: 0.85;
  }

</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script>
// make list of possible animal choices
var animal_dict = {
  "Grey Wolf": "Canis lupus",
  "Black Bear": "Ursus americanus",
  "North American Bison": "Bison bison",
  "Moose": "Alces alces",
  "Cougar": "Puma concolor",
  "Seal": "Phoca vitulina",
  "Whale": "Megaptera novaeangliae"
};

var animal_color = {
  "Canis lupus": "#1f77b4",
  "Ursus americanus": "#ff7f0e",
  "Bison bison": "#2ca02c",
  "Alces alces": "#d62728",
  "Puma concolor": "#9467bd",
  "Phoca vitulina": "#8c564b",
  "Megaptera novaeangliae": "#e377c2"
};

// make list of possible animal choices
var animals=Object.keys(animal_dict);
// For use in the Scientific Name column then grab the Park Name
var animal_sci=Object.values(animal_dict);
// Make dictionary of animal


var color = d3.scaleOrdinal(d3["schemeCategory10"]);
var legendHeight = d3.ticks(0, 20*(animals.length-1) , animals.length);

// initialize width and height
var width = window.innerWidth - 50;
var height = window.innerHeight;

// Slightly changed legend code from Mike Bostock:
// http://bl.ocks.org/mbostock/3888852
var legend = d3.select("#map").append("svg")
      		.attr("class", "legend")
     			.attr("width", 200)
    			.attr("height", (20*animals.length)+5)
          .attr("align", "center")
   			.selectAll("g")
   				.data(legendHeight)
   			.enter()
   				.append("g")
     			.attr("transform", function(data) {
            return "translate(0," + data + ")";
          });

legend.append("rect")
  .data(animal_sci)
		  .attr("width", 18)
		  .attr("height", 18)
    .attr("fill", function(data) { return animal_color[data]; });

legend.append("text")
	  .data(animals)
  	  .attr("x", 24)
  	  .attr("y", 9)
  	  .attr("dy", ".35em")
  	  .text( function(data) {
        return data;
      })
      // Add mouseover to change dots that appear
      .on("mouseover", function(data) {
        showParksWith(animal_dict[data].replace(/\s+/g, ''));
      })
      .on("mouseout", function(data) {
        showAllParks();
      });

// Create svg
var svg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

// D3 Projection
var projection = d3.geoAlbersUsa()
            .translate([width/2, height/2])
            .scale(1000);

// create u.s. path
var path = d3.geoPath()
    .projection(projection);

// allows objects to be in front of map
var g = svg.append("g");

// Add tooltip
var div = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

function showParksWith(someAnimal) {
  // set all of the parks to be transparent
  svg.selectAll("circle")
    .transition()
    .duration(500)
    .style("opacity", 0);

    // set the specific animal's parks to be opaque
    svg.selectAll("."+someAnimal)
      .transition()
      .duration(500)
      .style("opacity", 1);
}


function showAllParks(){
  // set all of the parks to be opaque
  svg.selectAll("circle")
    .transition()
    .duration(300)
    .style("opacity", 1);
}

function dataLoaded() {
  document.getElementById("more-info").innerHTML =
  "Hover over one of the animals in the legend to see which parks have them.";
}

var usJson = "https://gist.githubusercontent.com/mbostock/4090846/raw/07e73f3c2d21558489604a0bc434b3a5cf41a867/us.json";
d3.json(usJson, function(error, us) {
  if (error) throw error;

  g.selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("d", path)
      .attr("class", "feature");

  g.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "mesh")
      .attr("d", path);
});

var parksCsv = "https://gist.githubusercontent.com/meyerpa/1a5b1c3388e73ce2870c70fe2d42e55b/raw/89d66bdbb1f4af9a7c12afd1fd0aed1d27ca5f39/parks.csv";
d3.csv(parksCsv, function(data) {
      return {
        parkName: data['Park Name'],
        latitude: parseInt(data['Latitude']),
        longitude: parseInt(data['Longitude']),
        size: parseInt(data['Acres'])
      };
    }, function(data) {
  svg.selectAll("circle")                 // create virtual circle template
    .data(data)                           // bind data
  .enter()                                // for each row in data
    .append("circle")
    .attr('id', function(data) { return data.parkName.replace(/\s+/g, '' ) })
    .attr("r", function(data) {
      return Math.log(data.size/1000);
    })
    .attr("cx", function(data) {
      // Map longitude and latitude onto map, return null if outside
      var x = projection([data.longitude, data.latitude]);
      return (x == null ? null:  x[0]);
    })
    .attr("cy", function(data) {
      // Map longitude and latitude onto map, return null if outside
      var y = projection([data.longitude, data.latitude]);
      return (y == null ? null:  y[1]);
    })
    .attr("fill", "black")
    // Add tooltip
    .on("mouseover", function(data) {
      div.transition()
        .duration(300)
        .style("opacity", 0.97);
        div.text(data.parkName)
        .style("left", (d3.event.pageX) + "px")
        .style("top", (d3.event.pageY- 7) + "px");

    })
    .on("mouseout", function(data) {
        div.transition()
           .duration(300)
           .style("opacity", 0);
    })
  });

var species_csv = "https://gist.githubusercontent.com/meyerpa/dd799c36fe0ee80e1160f9a44c538236/raw/5251e7794f82dafb23384794eecfc9fa3f63bcae/species.csv";
d3.csv(species_csv, function(data) {
    return {
      parkName: data['Park Name'].replace(/\s+/g, ''),
      species: data['Scientific Name']
    };
  }, function(data) {
    for (var i=0; i<data.length; i++) {
      if (animal_sci.includes(data[i].species)) {
        console.log(data[i].species);
        console.log(animal_color[data[i].species]);
        svg.select("#"+data[i].parkName)
          // supposed to change the color of the circles, but isn't working
          .attr("fill", animal_color[data[i]])
          .attr("class",
            // append scientific name to class
            // this will label the obejcts for hover later
            // null doesn't matter so I won't
            // handle the case where it returns null
            svg.select("#"+data[i].parkName).attr("class") + " " +
            data[i].species.replace(/\s+/g, ''));

      }
    };
    // update text to let user know the data was loaded
    dataLoaded();
});


</script>
